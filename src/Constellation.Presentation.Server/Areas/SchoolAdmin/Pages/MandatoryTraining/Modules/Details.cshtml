@page "{Id:Guid}"
@model Constellation.Presentation.Server.Areas.SchoolAdmin.Pages.MandatoryTraining.Modules.DetailsModel
@inject IAuthorizationService AuthorizationService

@{
    var canEditTest = await AuthorizationService.AuthorizeAsync(User, AuthPolicies.CanEditTrainingModuleContent);
    var canRunReportsTest = await AuthorizationService.AuthorizeAsync(User, AuthPolicies.CanRunTrainingModuleReports);

    var completionsGroupedByYear = Model.Module.Completions
        .GroupBy(record => record.CompletedDate.Year)
        .OrderByDescending(group => group.Key);

    var firstIteration = true;
}

<h2>Training Module Details</h2>

<div>
    @if (canEditTest.Succeeded){
        <a asp-page="Upsert" asp-route-id="@Model.Module.Id" class="btn btn-warning">Edit</a>
        @if (Model.Module.IsActive)
        {
            <a asp-page-handler="RetireModule" class="btn btn-danger">Retire Module</a>
        } else 
        {
            <a asp-page-handler="ReinstateModule" class="btn btn-danger">Reinstate Module</a>
        }
    }

    @if (canRunReportsTest.Succeeded)
    {
        <a asp-page-handler="DownloadReport" class="btn btn-info">Download Report</a>
    }

    <a href="javascript:history.go(-1)" class="btn btn-danger btn-pull-right">Go Back</a>
</div>

<hr />

<div>
    <dl class="row">
        <dt class="col-md-2">
            <label asp-for="Module.Id"></label>
        </dt>
        <dd class="col-md-10">
            <span>@Model.Module.Id</span>
        </dd>

        <dt class="col-md-2">
            <label asp-for="Module.Name">Module</label>
        </dt>
        <dd class="col-md-10">
            <span>@Model.Module.Name</span>
        </dd>

        <dt class="col-md-2">
            <label asp-for="Module.Expiry">Expiry Frequency</label>
        </dt>
        <dd class="col-md-10">
            <span>@Model.Module.Expiry</span>
        </dd>

        <dt class="col-md-2">
            <label asp-for="Module.Url">Link</label>
        </dt>
        <dd class="col-md-10">
            <span><a href="@Model.Module.Url" target="_blank">@Model.Module.Url</a></span>
        </dd>
    </dl>
</div>

<hr />

<div>
    <ul class="nav nav-pills" data-tabs="tabs" role="tablist">
        @{
            firstIteration = true;

            foreach (var year in completionsGroupedByYear)
            {
                <li class="nav-item mr-1">
                    <a class="nav-link @(firstIteration ? "active" : "")" href="#Y-@year.Key" data-toggle="pill">
                        @year.Key
                    </a>
                </li>

                firstIteration = false;
            }
        }
    </ul>

    <div class="tab-content">
        @{
            firstIteration = true;

            foreach (var year in completionsGroupedByYear) 
            {
                <div id="Y-@year.Key" class="tab-pane @(firstIteration ? "active" : "")" role="tabpanel">
                    <h3>Records from @year.Key</h3>

                    <table class="table-striped table-hover data-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Name</th>
                                <th>Faculty</th>
                                <th>Completed Date</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in year.OrderBy(record => record.StaffLastName))
                            {
                                <tr>
                                    <td>
                                        @{
                                            if (item.Status == Constellation.Application.Features.MandatoryTraining.Models.CompletionRecordDto.ExpiryStatus.Active)
                                            {
                                                if (item.ExpiryCountdown > 31)
                                                {
                                                    <img src="/images/GreenLight.png" class="status-icon" title="@item.ExpiryCountdown Days Remaining" />
                                                }
                                                else if (item.ExpiryCountdown > 15)
                                                {
                                                    <img src="/images/YellowLight.png" class="status-icon" title="@item.ExpiryCountdown Days Remaining" />
                                                }
                                                else if (item.ExpiryCountdown > 1)
                                                {
                                                    <img src="/images/RedLight.png" class="status-icon" title="@item.ExpiryCountdown Days Remaining" />
                                                }
                                                else
                                                {
                                                    <img src="/images/RedLight.png" class="status-icon blink" title="@item.ExpiryCountdown Days Remaining" />
                                                }
                                            }
                                        }
                                    </td>
                                    <td>@item.StaffFirstName @item.StaffLastName</td>
                                    <td>@item.StaffFaculty</td>
                                    <td>@item.CompletedDate.ToString("dd/MM/yyyy")</td>
                                    <td>
                                        <a asp-page="/MandatoryTraining/Completion/Details" asp-route-id="@item.Id" class="btn btn-sm btn-secondary">More Details...</a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                firstIteration = false;
            }
        }
    </div>
</div>